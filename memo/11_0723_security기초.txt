ìŠ¤í”„ë§ì—ì„œ, ì‹œíë¦¬í‹° , ë²”ìœ„ ë§¤ìš° ë„“ìŠµë‹ˆë‹¤.
ì›¹, ë°±, ì•±, ì‘ìš©,
Spring web Security -> ì‹œíë¦¬í‹°ë¼ê³  ë¶€ë¥¼ ì˜ˆì •.

ì¸ì¦(authentication, ë¡œê·¸ì¸),
ì¸ê°€(authority í—ˆê°€, ê´€ë¦¬ì, ìœ ì €)
ì˜ˆ)
ì¸ì¦
ë¡œê·¸ì¸ í•œ ìœ ì €ë§Œ ë³¼ìˆ˜ ìˆê³ ,
ê²Œì‹œê¸€ ëª©ë¡ì€ ,
ê²Œì‹œê¸€ ì‘ì„±, ëŒ“ê¸€ ì‘ì„±.

ì¸ê°€.
ê´€ë¦¬ì í˜ì´ì§€ ì ‘ê·¼ - ê´€ë¦¬ìë§Œ, ì¼ë°˜ ìœ ì €ëŠ” ì ‘ê·¼ ëª»í•˜ê²Œ ë§‰ê¸°.


ì¸ì¦
1) í¼ ë°©ì‹ìœ¼ë¡œ, (ì„¸ì…˜, ì¿ í‚¤ë“±ì„ ì´ìš©í•´ì„œ) ì¸ì¦
2) í† í°ì„ ì´ìš©í•˜ëŠ” ë°©ì‹.(JWT), í”„ë¡ íŠ¸ - ë°±ì—”ë“œ(ë ˆìŠ¤íŠ¸ë¡œë§Œêµ¬ì„±ì‹œ)
3) ê¸°íƒ€, ìƒì²´ì¸ì¦, OTP, 2ë‹¨ê³„ ì¸ì¦.

ì¸ì¦, ì¸ê°€, ìë™ë¡œê·¸ì¸, ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ api(ë‹‰ë„¤ì„ê¹Œì§€ ì •ë³´ì œê³µ)
ë„¤ì´ë²„ ë¡œê·¸ì¸ api ,

ê¸°ë³¸ ì„¤ì •.

build.gradle
ë„êµ¬ ì„¤ì¹˜,
íŒŒë€ìƒ‰ êµì¬, maven ë¹Œë“œ íˆ´, pom.xml
mavenRepository ì‚¬ì´íŠ¸ ë“¤ì–´ê°€ë©´, 2ê°€ì§€ ê²½ìš°ì˜ ë„êµ¬ ì„¤ì¹˜ ë§í¬ ë‹¤ ìˆìŒ.

Spring Boot Starter Security Â» 3.3.0

// https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-security
implementation group: 'org.springframework.boot', name: 'spring-boot-starter-security', version: '3.4.0'

ì„¤ì¹˜ì‹œ,
ìŠ¤í”„ë§ì—ì„œ, ê¸°ë³¸ì´, get ì œì™¸í•œ ëª¨ë“  í˜•ì‹ì˜ í†µì‹ ì„ ë‹¤ ì°¨ë‹¨í•¨.
ê¸°ë³¸ê°’ìœ¼ë¡œ ì½˜ì†”ì—ì„œ,
id : user
pw : ì½˜ì†”ì—ì„œ ë§¤ë²ˆ ë³€ê²½ì´ ëœ íŒ¨ìŠ¤ì›Œë“œ ì œê³µí•´ì¤Œ.
ë¡œê·¸ì¸ í¼ ì œê³µ, ë¡œê·¸ ì•„ì›ƒ ì œê³µ, ë¡œê·¸ì¸ ë¡œì§ ì²˜ë¦¬ í•´ì¤Œ.

ìƒ˜í”Œ : ë§¤ë²ˆ ë³€ê²½
Using generated security password: 668de4cb-edd3-4567-b116-1144b65d933b

í™•ì¸ì‹œ,
ë§¤ë²ˆ, ì¸í…”ë¦¬ì œì´ì—ì„œ ì‘ì—… í›„, í¬ë¡¬ë“±ìœ¼ë¡œ ì´ë™ì‹œ,
ë§¤ë²ˆ ìë™ ë¦¬ë¡œë“œ , íŒ¨ìŠ¤ì›Œë“œ ê°€ ê³„ì† ìƒì„±ì´ ë˜ì–´ì„œ ,
í™•ì¸ ëª»í•¨.
í•´ê²°ì±….
application.properties
# devtools ë„ê¸°
spring.devtools.restart.enabled=false

ì„œë²„ ë‹¤ì‹œ ì¼œê³  í™•ì¸ í•˜ë©´ë¨.

ê·¸ëŸ¬ë©´, ì‹œíë¦¬í‹° í†µí•´ì„œ , ë¦¬ìŠ¤íŠ¸, ë‹¤ë¥¸ ì‘ì—…ì´ ê°€ëŠ¥í•¨.

ê°•ì œë¡œ ë¡œê·¸ì•„ì›ƒ
í¬ë¡¬ -> ê°œë°œìë„êµ¬ -> ì• í”Œë¦¬ì¼€ì´ì…˜ -> ì¿ í‚¤ -> JSESSIONID ì‚­ì œ í•˜ë©´, ë¡œê·¸ ì•„ì›ƒ.

ì‹œíë¦¬í‹° ì„¤ì • ë°©ë²•
1) application.properties
2) ì„¤ì • í´ë˜ìŠ¤ë¥¼ ì´ìš©í•˜ëŠ” ë°©ë²•.

ìš°ë¦¬ëŠ” ì„¤ì • í´ë˜ìŠ¤ë¥¼ ì´ìš©í•´ì„œ ì„¤ì • ë° í™•ì¸ í•  ì˜ˆì •.

ë¡œê¹…ì„ trace ì„¤ì •ì„ í–ˆê³ , ì¡°ê¸ˆ ë” êµ¬ì²´ì ìœ¼ë¡œ í™•ì¸ í•˜ê¸° ìœ„í•´ì„œ.

style.css, .js , ì •ì  ìì›, ì‹œíë¦¬í‹° ì„¤ì •ì„ í•  í•„ìš”ê°€ ì—†ë‹¤.

ê·¸ë˜ì„œ, ì œì™¸ í•˜ê¸°.

 //ì •ì  ìì› ì‹œíë¦¬í‹° í•„í„° í•­ëª©ì— ì œì™¸í•˜ê¸°.
    @Bean
    public WebSecurityCustomizer webSecurityCustomizer() {
        log.info("ì‹œíë¦¬í‹° ë™ì‘ í™•ì¸ ====webSecurityCustomizer======================");
        return (web) ->
                web.ignoring()
                        .requestMatchers(PathRequest.toStaticResources().atCommonLocations());
    }


ê¸°ì¡´ ë°©ì‹ê³¼ , ì‹œíë¦¬í‹°ì˜ ì°¨ì´ì .
ì•„ì´ë””, íŒ¨ìŠ¤ì›Œë“œ ì˜ ì¼ì¹˜ ì—¬ë¶€ì— ë”°ë¼ì„œ, ì¸ì¦ë§Œ.
ì‹œíë¦¬í‹°ì—ì„œëŠ” username ìœ¼ë¡œ í•´ë‹¹ ì •ë³´ë¥¼ ì¡°íšŒë¥¼ í•´ì„œ, ì¸ì¦, ì¸ê°€ í™•ì¸ì„ í•¨.

ìƒ˜í”Œ
public class CustomUserDetailsService implements UserDetailsService {

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        log.info("ì‹œíë¦¬í‹° loadUserByUsername í™•ì¸ : "+ username);
        return null;
    }

UserDetails ì˜ ëŒ€í‘œì ì¸ ì¶”ìƒë©”ì„œë“œ
- getAuthorities , ë¡œê·¸ì¸í•œ ìœ ì €ì˜ ì¸ì¦ ì •ë³´ë¥¼ ê°€ì§€ê³  ìˆë‹¤.

ì‹œíë¦¬í‹°ì—ì„œëŠ” ìœ ì €ì˜ íŒ¨ìŠ¤ì›Œë“œì˜ í‰ë¬¸ì„ ì‹«ì–´í•©ë‹ˆë‹¤.
í•´ì‹±ì„ í•œ , ì¸ì½”ë”©ì´ëœ ê°’ì„ ì¢‹ì•„ë¼í•¨. ê·¸ë˜ì„œ, ì´ê²Œ ê¸°ë³¸ê°’.
ìš°ë¦¬ëŠ” í•´ì‹œ í•¨ìˆ˜ í´ë˜ìŠ¤ë¥¼ ì„ ì •ì„í•´ì„œ, ë¹ˆìœ¼ë¡œ ì‹œìŠ¤í…œì— ë“±ë¡ì„ ì˜ë¬´ì ìœ¼ë¡œ í•´ì•¼í•¨.
PasswordEncoder ì¤‘ì—ì„œ,
BCryptPasswordEncoder ë¼ëŠ” í´ë˜ìŠ¤ë¥¼ ì´ìš©í•  ì˜ˆì •.
pw : 1111 -> í•´ì‹œ í•¨ìˆ˜ë¥¼ ì´ìš©í•œ ë§¤ë²ˆ ë‹¤ë¥¸ ë¬¸ìì—´ë¡œ ì•”í˜¸í™”í•¨.


íŠ¹ì • í˜ì´ì§€ ì´ë™ì‹œ , ê¶Œí•œì„ í™•ì¸ í›„ ì´ë™í•˜ëŠ” ì„¤ì •.
1) ì„¤ì • í´ë˜ìŠ¤
2) ì–´ë…¸í…Œì´ì…˜
ì´ìš©í•  ì˜ˆì •,
ì‚¬ìš©ë°©ë²•,
ì„¤ì • í´ë˜ìŠ¤ì—ì„œ.
// ì–´ë…¸í…Œì´ì…˜ì„ ì´ìš©í•´ì„œ, íŠ¹ì • ê¶Œí•œ ìˆëŠ” í˜ì´ì§€ ì ‘ê·¼ì‹œ, êµ¬ë¶„ê°€ëŠ¥.
@EnableGlobalMethodSecurity(prePostEnabled = true)

ì‚¬ìš© ì˜ˆ)
ì»¨íŠ¸ë¡¤ëŸ¬ ë“±ì—ì„œ.
 //ê¸€ì“°ê¸° ì²˜ë¦¬
    // ë¡œê·¸ì¸í•œ ìœ ì €ì´ê³ , ì¼ë°˜ ìœ ì €, ê¸€ì“°ê¸°ê°€ ê°€ëŠ¥í•˜ê²Œë” ì„¤ì •.
    @PreAuthorize("hasRole('USER')")
    @PostMapping("/register")

ì‚¬ìš©í•˜ëŠ” í˜•ì‹
- authenticated() : ì¸ì¦ëœ ì‚¬ìš©ìë“¤ë§Œ í—ˆìš©.
- permitAll() : ëª¨ë‘ í—ˆìš©.
- anonymous() : ìµëª…ì˜ ì‚¬ìš©ì í—ˆìš©(ë¹„íšŒì›)
- hasRole(í‘œí˜„ì‹) : íŠ¹ì •í•œ ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ì í—ˆìš©.
- hasAnyRole(í‘œí˜„ì‹) : ì—¬ëŸ¬ ê¶Œí•œ ì¤‘ í•˜ë‚˜ë§Œ ì¡´ì¬í•´ë„ í—ˆìš©.

ë²„ì „ ë³€ê²½ìœ¼ë¡œ ë¬¸ë²• ë³€ê²½í•˜ê¸°.
ì—¬ê¸° ìƒ˜í”Œ ì½”ë“œ í™œìš©í•˜ê¸°.
ê³µì‹ ë¬¸ì„œ : https://spring.io/guides/gs/securing-web

1
@EnableWebSecurity
public class CustomSecurityConfig {

}

2
 @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
 http.formLogin(
                formLogin -> formLogin.loginPage("/shopMember/login").permitAll()
        );
        // ê¸°ë³¸ì€ csrf ì„¤ì •ì´ on, ì‘ì—…ì‹œì—ëŠ” ë„ê³  ì‘ì—…í•˜ê¸°.
        http.csrf(httpSecurityCsrfConfigurer -> httpSecurityCsrfConfigurer.disable());

        http.authorizeRequests()
                .requestMatchers("/css/**", "/js/**","/image/**").permitAll()
                // ë¦¬ìŠ¤íŠ¸ëŠ” ê¸°ë³¸ìœ¼ë¡œ ë‹¤ ë“¤ì–´ê°ˆìˆ˜ ìˆê²Œ.
                .requestMatchers("/", "/board/list", "/login", "/joinUser","/joinForm","/findAll","/images/**").permitAll()
                // ë¡œê·¸ì¸ í›„ í™•ì¸ í•˜ê¸°.
                .requestMatchers("/board/register").hasRole("USER")
                //
                .requestMatchers("/admin","/images","/board/update").hasRole("ADMIN")
                // ìœ„ì˜ ì ‘ê·¼ ì œì–´ ëª©ë¡ ì™¸ì˜ , ë‹¤ë¥¸ ì–´ë–¤ ìš”ì²­ì´ë¼ë„ ë°˜ë“œì‹œ ì¸ì¦ì´ ë˜ì–´ì•¼ ì ‘ê·¼ì´ ëœë‹¤.
                .anyRequest().authenticated()
        ;

        return http.build();

    }

ì‹œíë¦¬í‹° ì‹œìŠ¤í…œì—ì„œ ì •í•œ ë¡œê·¸ ì•„ì›ƒ.
http://localhost:8080/logout

3. ìë™ ë¡œê·¸ì¸ì„ ìœ„í•œ í…Œì´ë¸”
ìŠ¤í”„ë§ì—ì„œ ì œê³µí•˜ëŠ” í…Œì´ë¸”ëª… : persistent_logins , ë™ì¼í•´ì•¼í•¨.
create table persistent_logins(
    username varchar(64) not null,
    series varchar(64) primary key,
    token varchar(64) not null,
    last_used timestamp not null
);
=====================================================
ì¶”ê°€ ì„¤ëª…
 persistent_logins í…Œì´ë¸” ê°œìš”
ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì—ì„œ ì˜êµ¬ í† í° ê¸°ë°˜ Remember-Me ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ë•Œ í•„ìš”í•œ í‘œì¤€ í…Œì´ë¸”ì…ë‹ˆë‹¤. ì´ í…Œì´ë¸”ì€ ì‚¬ìš©ìì˜ ìë™ ë¡œê·¸ì¸ ì •ë³´ë¥¼ ì•ˆì „í•˜ê²Œ ì €ì¥í•©ë‹ˆë‹¤.
ğŸ” ì»¬ëŸ¼ ìƒì„¸ ì„¤ëª…
1. username (varchar(64) not null)

ì‚¬ìš©ìì˜ ë¡œê·¸ì¸ IDë¥¼ ì €ì¥
UserDetailsì˜ usernameê³¼ ë§¤í•‘
í•œ ì‚¬ìš©ìê°€ ì—¬ëŸ¬ ê¸°ê¸°ì—ì„œ ë¡œê·¸ì¸í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ Primary Keyê°€ ì•„ë‹˜

2. series (varchar(64) primary key)

ê° Remember-Me ì„¸ì…˜ì˜ ê³ ìœ  ì‹ë³„ì
ëœë¤í•˜ê²Œ ìƒì„±ëœ Base64 ì¸ì½”ë”© ë¬¸ìì—´ = UUID, ëœë¤ ë¬¸ìì—´, ì¤‘ë³µ ë°©ì§€.
ë¸Œë¼ìš°ì €/ê¸°ê¸°ë³„ë¡œ ê³ ìœ í•œ ê°’ í• ë‹¹
ì¿ í‚¤ íƒˆì·¨ ê³µê²© ê°ì§€ì— ì‚¬ìš©

3. token (varchar(64) not null)

ì‹¤ì œ ì¸ì¦ì— ì‚¬ìš©ë˜ëŠ” í† í° ê°’
ë§¤ ìš”ì²­ë§ˆë‹¤ ìƒˆë¡œìš´ ê°’ìœ¼ë¡œ ê°±ì‹  (ë³´ì•ˆ ê°•í™”)
Base64ë¡œ ì¸ì½”ë”©ëœ ëœë¤ ë¬¸ìì—´

4. last_used (timestamp not null)

ë§ˆì§€ë§‰ìœ¼ë¡œ í† í°ì´ ì‚¬ìš©ëœ ì‹œê°„
í† í° ë§Œë£Œ ì—¬ë¶€ íŒë‹¨ì— ì‚¬ìš©
ì‚¬ìš©ì í™œë™ ì¶”ì  ê°€ëŠ¥

ğŸ›¡ï¸ ë³´ì•ˆ ë©”ì»¤ë‹ˆì¦˜
í† í° ê°±ì‹  ë°©ì‹
ìµœì´ˆ ë¡œê·¸ì¸ â†’ series ìƒì„± â†’ token ìƒì„±
â†“
ìë™ ë¡œê·¸ì¸ ì‹œë„ â†’ series ê²€ì¦ â†’ token ê²€ì¦
â†“
ì„±ê³µ ì‹œ â†’ ë™ì¼ series ìœ ì§€ â†’ ìƒˆë¡œìš´ token ìƒì„±
ì¿ í‚¤ êµ¬ì¡°
Remember-Me ì¿ í‚¤ëŠ” ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤:
Base64(series + ":" + token)
================================================


í™”ë©´ì—ì„œ, ì¸ì¦ì´ ëœ ìœ ì €ì¼ ê²½ìš°, ì¡°ê±´ì— ë§ê²Œ, íŠ¹ì •ì˜ í™”ë©´ì´ ë³´ì´ê²Œ í• ë ¤ë©´,
ë„êµ¬ê°€ í•„ìš”í•´ìš”, íƒ€ì„ë¦¬í”„ì—ì„œ
thymeleaf-extras-springsecurity6  ë„êµ¬ê°€ í•„ìš”í•´ìš”

// https://mvnrepository.com/artifact/org.thymeleaf.extras/thymeleaf-extras-springsecurity6
    implementation group: 'org.thymeleaf.extras', name: 'thymeleaf-extras-springsecurity6', version: '3.1.2.RELEASE'

.
ì˜ˆ) ë¡œê·¸ì¸ ìœ ì €ì¼ ê²½ìš°, ë¡œê·¸ ì•„ì›ƒ ë²„íŠ¼ì„ ë³´ì´ê²Œ í•˜ê±°ë‚˜,
ê´€ë¼ì§€ ì¼ ê²½ìš° ,ê´€ë¦¬ì í˜ì´ì§€ ë§í¬ê°€ ë³´ì´ê²Œ í•˜ê±°ë‚˜, ë“±.

register.html ì—ì„œ,
ìœ ì € ê¶Œí•œë³„ í™”ë©´ í‘œì‹œí•˜ëŠ” ë„êµ¬ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œ ì„¤ì • íƒœê·¸ ì¶”ê°€.
xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"


ì‹œíë¦¬í‹° ë¡œê·¸ì¸ í›„,
ì„œë²„ì—ì„œ ì‚¬ìš©í•˜ëŠ” ë°©ë²•
1.
    @GetMapping("/list")
    // ë¡œê·¸ì¸í•œ ìœ ì €ì˜ ì •ë³´ë¥¼, ì„œë²„ -> í™”ë©´ì— ì œê³µí•˜ëŠ” ë°©ë²•,
    // ë©”ì„œë“œ ì•ˆì— íŒŒë¼ë¯¸í„°ì— , @AuthenticationPrincipal UserDetails user
    // user ê°ì²´ ì•ˆì— ë¡œê·¸ì´í•œ ìœ ì € ì •ë³´ê°€ ìˆìŒ.
    public void list(@AuthenticationPrincipal UserDetails user, ..) {
    ...
      // user ì •ë³´ë¥¼ í™”ë©´ì— ì „ë‹¬í•˜ê¸°.
            model.addAttribute("user", user);
    }

2. í™”ë©´ì—ì„œ , ìë°”ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œì—ì„œ ë¡œê·¸ì¸ ìœ ì € ë°”ë¡œ ì‚¬ìš©í•˜ëŠ” ë°©ë²•

  const currentUser = [[${#authentication.principal.username}]]
    console.log("currentUser : " + currentUser)


3.
<!-- ë¡œê·¸ì¸í•œ ìœ ì € ì„.-->
<div class="mb-3" th:with="user=${#authentication.principal}">
    <div th:with="link = ${pageRequestDTO.getLink()}">
    <a th:if="${user != null && user.username==boardDTO.writer}" th:href="|@{/board/update(bno =${boardDTO.bno})}&${link}|">
        <button type="button" class="btn btn-primary">ìˆ˜ì •í•˜ê¸°</button>
    </a>

4. ê¶Œí•œë³„ , í™”ë©´ì—ì„œ ì ‘ê·¼ ì œì–´í•˜ëŠ” ì˜ˆì‹œ.
  <!--    ë¡œê·¸ì¸ì‹œ ê¶Œí•œë³„ë¡œ ì–´ë“œë¯¼ í˜ì´ì§€ í‘œì‹œ í•´ë³´ê¸°-->
<!-- íƒ€ì„ë¦¬í”„ì˜ ê¸°ëŠ¥ ì¤‘ì— sec ì ‘ë‘ì–´, ê¸°ëŠ¥ ë”°ë¡œ ë„êµ¬ë¥¼ ì„¤ì¹˜-->
<li class="nav-item"  sec:authorize="hasAnyAuthority('ROLE_ADMIN')">
    <a class="nav-link" href="#" >ê´€ë¦¬ìí˜ì´ì§€</a>
</li>